/* anime-db-form-type-image-bundle 2016-04-21 */
!function($){function empty(){}jQuery.event.props.push("dataTransfer");var default_opts={fallback_id:"",url:"",refresh:1e3,paramname:"userfile",requestType:"POST",allowedfileextensions:[],allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:empty,dragStart:empty,dragEnter:empty,dragOver:empty,dragLeave:empty,docEnter:empty,docOver:empty,docLeave:empty,beforeEach:empty,afterAll:empty,rename:empty,error:function(err,file,i,status){alert(err)},uploadStarted:empty,uploadFinished:empty,progressUpdated:empty,globalProgressUpdated:empty,speedUpdated:empty},errors=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError","FileExtensionNotAllowed"];$.fn.filedrop=function(options){function drop(e){if(opts.drop.call(this,e)===!1)return!1;if(e.dataTransfer)return files=e.dataTransfer.files,null===files||void 0===files||0===files.length?(opts.error(errors[0]),!1):(files_count=files.length,upload(),e.preventDefault(),!1)}function getBuilder(filename,filedata,mime,boundary){var dashdash="--",crlf="\r\n",builder="",paramname=opts.paramname;if(opts.data){var params=$.param(opts.data).replace(/\+/g,"%20").split(/&/);$.each(params,function(){var pair=this.split("=",2),name=decodeURIComponent(pair[0]),val=decodeURIComponent(pair[1]);2===pair.length&&(builder+=dashdash,builder+=boundary,builder+=crlf,builder+='Content-Disposition: form-data; name="'+name+'"',builder+=crlf,builder+=crlf,builder+=val,builder+=crlf)})}return jQuery.isFunction(paramname)&&(paramname=paramname(filename)),builder+=dashdash,builder+=boundary,builder+=crlf,builder+='Content-Disposition: form-data; name="'+(paramname||"")+'"',builder+='; filename="'+encodeURIComponent(filename)+'"',builder+=crlf,builder+="Content-Type: "+mime,builder+=crlf,builder+=crlf,builder+=filedata,builder+=crlf,builder+=dashdash,builder+=boundary,builder+=dashdash,builder+=crlf}function progress(e){if(e.lengthComputable){var percentage=Math.round(100*e.loaded/e.total);if(this.currentProgress!==percentage){this.currentProgress=percentage,opts.progressUpdated(this.index,this.file,this.currentProgress),global_progress[this.global_progress_index]=this.currentProgress,globalProgress();var elapsed=(new Date).getTime(),diffTime=elapsed-this.currentStart;if(diffTime>=opts.refresh){var diffData=e.loaded-this.startData,speed=diffData/diffTime;opts.speedUpdated(this.index,this.file,speed),this.startData=e.loaded,this.currentStart=elapsed}}}}function globalProgress(){if(0!==global_progress.length){var index,total=0;for(index in global_progress)global_progress.hasOwnProperty(index)&&(total+=global_progress[index]);opts.globalProgressUpdated(Math.round(total/global_progress.length))}}function upload(){if(stop_loop=!1,!files)return opts.error(errors[0]),!1;if(opts.allowedfiletypes.push&&opts.allowedfiletypes.length)for(var fileIndex=files.length;fileIndex--;)if(!files[fileIndex].type||$.inArray(files[fileIndex].type,opts.allowedfiletypes)<0)return opts.error(errors[3],files[fileIndex]),!1;if(opts.allowedfileextensions.push&&opts.allowedfileextensions.length)for(var fileIndex=files.length;fileIndex--;){var allowedextension=!1;for(i=0;i<opts.allowedfileextensions.length;i++)files[fileIndex].name.substr(files[fileIndex].name.length-opts.allowedfileextensions[i].length).toLowerCase()==opts.allowedfileextensions[i].toLowerCase()&&(allowedextension=!0);if(!allowedextension)return opts.error(errors[8],files[fileIndex]),!1}var filesDone=0,filesRejected=0;if(files_count>opts.maxfiles&&0===opts.queuefiles)return opts.error(errors[1]),!1;for(var workQueue=[],processingQueue=[],doneQueue=[],i=0;files_count>i;i++)workQueue.push(i);var pause=function(timeout){setTimeout(process,timeout)},process=function(){var fileIndex;if(stop_loop)return!1;if(opts.queuefiles>0&&processingQueue.length>=opts.queuefiles)return pause(opts.queuewait);fileIndex=workQueue[0],workQueue.splice(0,1),processingQueue.push(fileIndex);try{if(beforeEach(files[fileIndex])!==!1){if(fileIndex===files_count)return;var reader=new FileReader,max_file_size=1048576*opts.maxfilesize;if(reader.index=fileIndex,files[fileIndex].size>max_file_size)return opts.error(errors[2],files[fileIndex],fileIndex),processingQueue.forEach(function(value,key){value===fileIndex&&processingQueue.splice(key,1)}),filesRejected++,!0;reader.onerror=function(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:return opts.error(errors[4]),!1;case e.target.error.NOT_READABLE_ERR:return opts.error(errors[5]),!1;case e.target.error.ABORT_ERR:return opts.error(errors[6]),!1;default:return opts.error(errors[7]),!1}},reader.onloadend=opts.beforeSend?function(e){opts.beforeSend(files[fileIndex],fileIndex,function(){send(e)})}:send,reader.readAsDataURL(files[fileIndex])}else filesRejected++}catch(err){return processingQueue.forEach(function(value,key){value===fileIndex&&processingQueue.splice(key,1)}),opts.error(errors[0]),!1}workQueue.length>0&&process()},send=function(e){var fileIndex=(e.srcElement||e.target).index;void 0===e.target.index&&(e.target.index=getIndexBySize(e.total));var builder,xhr=new XMLHttpRequest,upload=xhr.upload,file=files[e.target.index],index=e.target.index,start_time=(new Date).getTime(),boundary="------multipartformboundary"+(new Date).getTime(),global_progress_index=global_progress.length,newName=rename(file.name),mime=file.type;opts.withCredentials&&(xhr.withCredentials=opts.withCredentials);var data=atob(e.target.result.split(",")[1]);builder="string"==typeof newName?getBuilder(newName,data,mime,boundary):getBuilder(file.name,data,mime,boundary),upload.index=index,upload.file=file,upload.downloadStartTime=start_time,upload.currentStart=start_time,upload.currentProgress=0,upload.global_progress_index=global_progress_index,upload.startData=0,upload.addEventListener("progress",progress,!1),jQuery.isFunction(opts.url)?xhr.open(opts.requestType,opts.url(),!0):xhr.open(opts.requestType,opts.url,!0),xhr.setRequestHeader("content-type","multipart/form-data; boundary="+boundary),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),$.each(opts.headers,function(k,v){xhr.setRequestHeader(k,v)}),xhr.sendAsBinary||(xhr.sendAsBinary=function(datastr){function byteValue(x){return 255&x.charCodeAt(0)}var ords=Array.prototype.map.call(datastr,byteValue),ui8a=new Uint8Array(ords);this.send(ui8a.buffer)}),xhr.sendAsBinary(builder),global_progress[global_progress_index]=0,globalProgress(),opts.uploadStarted(index,file,files_count),xhr.onload=function(){var serverResponse=null;if(xhr.responseText)try{serverResponse=jQuery.parseJSON(xhr.responseText)}catch(e){serverResponse=xhr.responseText}var now=(new Date).getTime(),timeDiff=now-start_time,result=opts.uploadFinished(index,file,serverResponse,timeDiff,xhr);filesDone++,processingQueue.forEach(function(value,key){value===fileIndex&&processingQueue.splice(key,1)}),doneQueue.push(fileIndex),global_progress[global_progress_index]=100,globalProgress(),filesDone===files_count-filesRejected&&afterAll(),result===!1&&(stop_loop=!0),(xhr.status<200||xhr.status>299)&&opts.error(xhr.statusText,file,fileIndex,xhr.status)}};process()}function getIndexBySize(size){for(var i=0;files_count>i;i++)if(files[i].size===size)return i}function rename(name){return opts.rename(name)}function beforeEach(file){return opts.beforeEach(file)}function afterAll(){return opts.afterAll()}function dragEnter(e){clearTimeout(doc_leave_timer),e.preventDefault(),opts.dragEnter.call(this,e)}function dragOver(e){clearTimeout(doc_leave_timer),e.preventDefault(),opts.docOver.call(this,e),opts.dragOver.call(this,e)}function dragLeave(e){clearTimeout(doc_leave_timer),opts.dragLeave.call(this,e),e.stopPropagation()}function docDrop(e){return e.preventDefault(),opts.docLeave.call(this,e),!1}function docEnter(e){return clearTimeout(doc_leave_timer),e.preventDefault(),opts.docEnter.call(this,e),!1}function docOver(e){return clearTimeout(doc_leave_timer),e.preventDefault(),opts.docOver.call(this,e),!1}function docLeave(e){doc_leave_timer=setTimeout(function(_this){return function(){opts.docLeave.call(_this,e)}}(this),200)}var doc_leave_timer,files,opts=$.extend({},default_opts,options),global_progress=[],stop_loop=!1,files_count=0;return $("#"+opts.fallback_id).css({display:"none",width:0,height:0}),this.on("drop",drop).on("dragstart",opts.dragStart).on("dragenter",dragEnter).on("dragover",dragOver).on("dragleave",dragLeave),$(document).on("drop",docDrop).on("dragenter",docEnter).on("dragover",docOver).on("dragleave",docLeave),this.on("click",function(e){$("#"+opts.fallback_id).trigger(e)}),$("#"+opts.fallback_id).change(function(e){opts.drop(e),files=e.target.files,files_count=files.length,upload()}),this};try{if(XMLHttpRequest.prototype.sendAsBinary)return;XMLHttpRequest.prototype.sendAsBinary=function(datastr){function byteValue(x){return 255&x.charCodeAt(0)}var ords=Array.prototype.map.call(datastr,byteValue),ui8a=new Uint8Array(ords);"ArrayBufferView"in window?this.send(ui8a):this.send(ui8a.buffer)}}catch(e){}}(jQuery);