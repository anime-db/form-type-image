/* anime-db-form-type-image-bundle 2016-04-22 */
!function(a){function b(){}jQuery.event.props.push("dataTransfer");var c={fallback_id:"",url:"",refresh:1e3,paramname:"userfile",requestType:"POST",allowedfileextensions:[],allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:b,dragStart:b,dragEnter:b,dragOver:b,dragLeave:b,docEnter:b,docOver:b,docLeave:b,beforeEach:b,afterAll:b,rename:b,error:function(a,b,c,d){alert(a)},uploadStarted:b,uploadFinished:b,progressUpdated:b,globalProgressUpdated:b,speedUpdated:b},d=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError","FileExtensionNotAllowed"];a.fn.filedrop=function(b){function e(a){if(w.drop.call(this,a)===!1)return!1;if(a.dataTransfer)return v=a.dataTransfer.files,null===v||void 0===v||0===v.length?(w.error(d[0]),!1):(z=v.length,i(),a.preventDefault(),!1)}function f(b,c,d,e){var f="--",g="\r\n",h="",i=w.paramname;if(w.data){var j=a.param(w.data).replace(/\+/g,"%20").split(/&/);a.each(j,function(){var a=this.split("=",2),b=decodeURIComponent(a[0]),c=decodeURIComponent(a[1]);2===a.length&&(h+=f,h+=e,h+=g,h+='Content-Disposition: form-data; name="'+b+'"',h+=g,h+=g,h+=c,h+=g)})}return jQuery.isFunction(i)&&(i=i(b)),h+=f,h+=e,h+=g,h+='Content-Disposition: form-data; name="'+(i||"")+'"',h+='; filename="'+encodeURIComponent(b)+'"',h+=g,h+="Content-Type: "+d,h+=g,h+=g,h+=c,h+=g,h+=f,h+=e,h+=f,h+=g}function g(a){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);if(this.currentProgress!==b){this.currentProgress=b,w.progressUpdated(this.index,this.file,this.currentProgress),x[this.global_progress_index]=this.currentProgress,h();var c=(new Date).getTime(),d=c-this.currentStart;if(d>=w.refresh){var e=a.loaded-this.startData,f=e/d;w.speedUpdated(this.index,this.file,f),this.startData=a.loaded,this.currentStart=c}}}}function h(){if(0!==x.length){var a,b=0;for(a in x)x.hasOwnProperty(a)&&(b+=x[a]);w.globalProgressUpdated(Math.round(b/x.length))}}function i(){if(y=!1,!v)return w.error(d[0]),!1;if(w.allowedfiletypes.push&&w.allowedfiletypes.length)for(var b=v.length;b--;)if(!v[b].type||a.inArray(v[b].type,w.allowedfiletypes)<0)return w.error(d[3],v[b]),!1;if(w.allowedfileextensions.push&&w.allowedfileextensions.length)for(var b=v.length;b--;){var c=!1;for(q=0;q<w.allowedfileextensions.length;q++)v[b].name.substr(v[b].name.length-w.allowedfileextensions[q].length).toLowerCase()==w.allowedfileextensions[q].toLowerCase()&&(c=!0);if(!c)return w.error(d[8],v[b]),!1}var e=0,i=0;if(z>w.maxfiles&&0===w.queuefiles)return w.error(d[1]),!1;for(var n=[],o=[],p=[],q=0;z>q;q++)n.push(q);var r=function(a){setTimeout(s,a)},s=function(){var a;if(y)return!1;if(w.queuefiles>0&&o.length>=w.queuefiles)return r(w.queuewait);a=n[0],n.splice(0,1),o.push(a);try{if(l(v[a])!==!1){if(a===z)return;var b=new FileReader,c=1048576*w.maxfilesize;if(b.index=a,v[a].size>c)return w.error(d[2],v[a],a),o.forEach(function(b,c){b===a&&o.splice(c,1)}),i++,!0;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:return w.error(d[4]),!1;case a.target.error.NOT_READABLE_ERR:return w.error(d[5]),!1;case a.target.error.ABORT_ERR:return w.error(d[6]),!1;default:return w.error(d[7]),!1}},b.onloadend=w.beforeSend?function(b){w.beforeSend(v[a],a,function(){t(b)})}:t,b.readAsDataURL(v[a])}else i++}catch(e){return o.forEach(function(b,c){b===a&&o.splice(c,1)}),w.error(d[0]),!1}n.length>0&&s()},t=function(b){var c=(b.srcElement||b.target).index;void 0===b.target.index&&(b.target.index=j(b.total));var d,l=new XMLHttpRequest,n=l.upload,q=v[b.target.index],r=b.target.index,s=(new Date).getTime(),t="------multipartformboundary"+(new Date).getTime(),u=x.length,A=k(q.name),B=q.type;w.withCredentials&&(l.withCredentials=w.withCredentials);var C=atob(b.target.result.split(",")[1]);d="string"==typeof A?f(A,C,B,t):f(q.name,C,B,t),n.index=r,n.file=q,n.downloadStartTime=s,n.currentStart=s,n.currentProgress=0,n.global_progress_index=u,n.startData=0,n.addEventListener("progress",g,!1),jQuery.isFunction(w.url)?l.open(w.requestType,w.url(),!0):l.open(w.requestType,w.url,!0),l.setRequestHeader("content-type","multipart/form-data; boundary="+t),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.each(w.headers,function(a,b){l.setRequestHeader(a,b)}),l.sendAsBinary||(l.sendAsBinary=function(a){function b(a){return 255&a.charCodeAt(0)}var c=Array.prototype.map.call(a,b),d=new Uint8Array(c);this.send(d.buffer)}),l.sendAsBinary(d),x[u]=0,h(),w.uploadStarted(r,q,z),l.onload=function(){var a=null;if(l.responseText)try{a=jQuery.parseJSON(l.responseText)}catch(b){a=l.responseText}var d=(new Date).getTime(),f=d-s,g=w.uploadFinished(r,q,a,f,l);e++,o.forEach(function(a,b){a===c&&o.splice(b,1)}),p.push(c),x[u]=100,h(),e===z-i&&m(),g===!1&&(y=!0),(l.status<200||l.status>299)&&w.error(l.statusText,q,c,l.status)}};s()}function j(a){for(var b=0;z>b;b++)if(v[b].size===a)return b}function k(a){return w.rename(a)}function l(a){return w.beforeEach(a)}function m(){return w.afterAll()}function n(a){clearTimeout(u),a.preventDefault(),w.dragEnter.call(this,a)}function o(a){clearTimeout(u),a.preventDefault(),w.docOver.call(this,a),w.dragOver.call(this,a)}function p(a){clearTimeout(u),w.dragLeave.call(this,a),a.stopPropagation()}function q(a){return a.preventDefault(),w.docLeave.call(this,a),!1}function r(a){return clearTimeout(u),a.preventDefault(),w.docEnter.call(this,a),!1}function s(a){return clearTimeout(u),a.preventDefault(),w.docOver.call(this,a),!1}function t(a){u=setTimeout(function(b){return function(){w.docLeave.call(b,a)}}(this),200)}var u,v,w=a.extend({},c,b),x=[],y=!1,z=0;return a("#"+w.fallback_id).css({display:"none",width:0,height:0}),this.on("drop",e).on("dragstart",w.dragStart).on("dragenter",n).on("dragover",o).on("dragleave",p),a(document).on("drop",q).on("dragenter",r).on("dragover",s).on("dragleave",t),this.on("click",function(b){a("#"+w.fallback_id).trigger(b)}),a("#"+w.fallback_id).change(function(a){w.drop(a),v=a.target.files,z=v.length,i()}),this};try{if(XMLHttpRequest.prototype.sendAsBinary)return;XMLHttpRequest.prototype.sendAsBinary=function(a){function b(a){return 255&a.charCodeAt(0)}var c=Array.prototype.map.call(a,b),d=new Uint8Array(c);"ArrayBufferView"in window?this.send(d):this.send(d.buffer)}}catch(e){}}(jQuery),function(a){var b=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b.prototype},c=function(){this._controller=null};c.prototype={setController:function(a){this._controller=a},getController:function(){return this._controller},bind:function(a){throw new Error("Must be implemented")}};var d=function(a){this._controls=[],this._token=a};d.prototype={addControl:function(a,b){b instanceof c&&(b.setController(this),this._controls[a]=b)},bindControl:function(a){var b=a.data("control");this._controls[b]instanceof c&&this._controls[b].bind(a)},bind:function(b){if(b=a(b||"body"),b.data("control"))this.bindControl(b);else{var c=this;b.find("[data-control]").each(function(){c.bindControl(a(this))})}},getToken:function(){return this._token}};var e=function(){this._token="",this._url="",this._wait=!1};e.prototype={getToken:function(){return this._token},setUrl:function(a){this._url=a,a&&!this._token&&this.refreshToken()},refreshToken:function(b){if(!this._wait&&this._url){this._wait=!0;var c=this;a.ajax({url:this._url,type:"POST",dataType:"text",processData:!1,contentType:!1,success:function(a){c._token=a,c._wait=!1,(b||function(){})()},complete:function(){c._wait=!1}})}}};var f=function(b,c){this._control=c,this.image=null,this.input=null,this.file=null,this.container=b,this.path=b.data("upload-path"),this.error=a('<div class="upload-image__alert alert alert-danger" role="alert"></div>').hide(),this.container.after(this.error)};f.prototype={init:function(){this.image=this.container.find("img"),this.input=this.container.find("input[type=text]"),this.file=this.container.find("input[type=file]");var a=this;this.fileDropBlock(),this.file.on("change",function(){a.doUpload(this.files[0])})},fileDropBlock:function(){var a=this;this.container.filedrop({url:a.path,paramname:"form[file]",data:{form:{_token:function(){return a._control.getController().getToken().getToken()}}},maxfiles:1,maxfilesize:2,error:function(b,c){switch(b){case"BrowserNotSupported":a.showError("Старый браузер");break;case"FileTooLarge":a.showError("Файл слишком большой");break;case"TooManyFiles":a.showError("Можно загрузить только 1 файл");break;case"FileTypeNotAllowed":a.showError("Некорректный тип файла");break;default:a.showError("Не удалось загрузить картинку")}},allowedfiletypes:["image/jpeg","image/png","image/gif"],allowedfileextensions:[".jpg",".jpeg",".png",".gif"],dragOver:function(){a.container.addClass("upload-image_dragging")},dragLeave:function(){a.container.removeClass("upload-image_dragging")},uploadStarted:function(){a.container.removeClass("upload-image_dragging"),a.error.hide()},uploadFinished:function(b,c,d){a.setInputValueFromResponse(d)}})},doUpload:function(b){this.error.hide();var c;if(window.FormData&&(formdata=new FormData),window.FileReader&&(c=new FileReader,c.readAsDataURL(b)),formdata&&(formdata.append("form[file]",b),formdata.append("form[_token]",this._control.getController().getToken().getToken())),-1!=a.inArray(b.type,["image/jpeg","image/png","image/gif"])){var d=this;a.ajax({url:d.path,type:"POST",data:formdata,dataType:"json",processData:!1,contentType:!1,success:function(a){0==a.status?d.showError(a.message):d.setInputValueFromResponse(a),d._control.getController().getToken().refreshToken()}})}else this.showError("Неправельный тип файла");this.file.blur()},setInputValueFromResponse:function(a){this.input.val(a.filename),this.image.attr("src",a.web_path)},showError:function(a){this.error.text(a).show()}};var g=function(){};b(g,c),g.prototype.bind=function(a){this._controller.getToken().setUrl(a.data("generate-token")),new f(a,this).init()};var h=function(b,c){this._control=c,this._drop_block=b.find(b.data("drop-block")),this._single_upload_path=b.data("single-upload-path"),this._milti_upload_path=b.data("milti-upload-path"),this._limit=b.data("upload-limit"),this._container=b.find(b.data("container")),this._file=this._drop_block.find("input[type=file]"),this._error=a('<div class="form-image-collection__alert alert alert-danger" role="alert"></div>').hide()};h.prototype={init:function(){this._drop_block.before(this._error);var a=this;this.fileDropBlock(),this._file.on("change",function(){a.doUpload(this)})},fileDropBlock:function(){var a=this;this._drop_block.filedrop({url:a._single_upload_path,paramname:"form[file]",data:{form:{_token:function(){return a._control.getController().getToken().getToken()}}},maxfiles:this._limit,maxfilesize:2,error:function(b,c){switch(b){case"BrowserNotSupported":a.showError("Старый браузер");break;case"FileTooLarge":a.showError("Файлы слишком большие");break;case"TooManyFiles":a.showError("Можно загрузить только "+a._limit+" файлов");break;case"FileTypeNotAllowed":a.showError("Некорректный тип файлов");break;default:a.showError("Не удалось загрузить картинки")}},allowedfiletypes:["image/jpeg","image/png","image/gif"],allowedfileextensions:[".jpg",".jpeg",".png",".gif"],dragOver:function(){a._drop_block.addClass("form-image-collection_dragging")},dragLeave:function(){a._drop_block.removeClass("form-image-collection_dragging")},uploadStarted:function(){a._drop_block.removeClass("form-image-collection_dragging"),a._error.hide()},uploadFinished:function(b,c,d){a.addFile(d)},afterAll:function(){a._control.getController().getToken().refreshToken()}})},doUpload:function(b){if(this._error.hide(),b.files.length){if(b.files.length>this._limit)return void this.showError("Можно загрузить только "+this._limit+" файлов");for(var c,d,e=window.FormData?new FormData:null,f=0;f<b.files.length;f++)d=b.files[f],window.FileReader&&(c=new FileReader,c.readAsDataURL(d)),e&&-1!=a.inArray(d.type,["image/jpeg","image/png","image/gif"])&&e.append("form[files][]",d);if(e){e.append("form[_token]",this._control.getController().getToken().getToken());var g=this;a.ajax({url:g._milti_upload_path,type:"POST",data:e,dataType:"json",processData:!1,contentType:!1,success:function(a){1==a.status?g.addFiles(a.files):g.showError(a.message),g._control.getController().getToken().refreshToken()},error:function(){g.showError("Не удалось загрузить картинки")}})}else this.showError("Неправельный тип файла");this._file.blur()}},addFiles:function(a){for(var b=0;b<a.length;b++)this.addFile(a[b])},addFile:function(a){this._container.find(".sonata-collection-add").trigger("click");var b=this._container.find(".sonata-collection-row:last");b.find(".upload-image input[type=text]").val(a.filename),b.find(".upload-image img").attr("src",a.web_path),this._control.getController().bind(b)},showError:function(a){this._error.text(a).show(),this._file.blur()}};var i=function(){};b(i,c),i.prototype.bind=function(a){this._controller.getToken().setUrl(a.data("generate-token")),new h(a,this).init()};var j=new d(new e);j.addControl("form-image",new g),j.addControl("form-image-collection",new i),a(function(){j.bind(),a("div[id^=sonata-ba-field-container-]").on("sonata.add_element",function(a){j.bind(a.target)}),a("div[id$=collection__container]").on("sonata-collection-item-added",function(a){j.bind(a.target)})})}(jQuery);